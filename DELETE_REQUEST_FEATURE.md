# ููุฒุฉ ุทูุจ ุญุฐู ุงูุญุณุงุจ

## ๐ ูุธุฑุฉ ุนุงูุฉ
ุชู ุชุญููู ูุธุงู ุญุฐู ุงูุญุณุงุจ ูู **ุญุฐู ููุฑู** ุฅูู **ูุธุงู ุทูุจุงุช** ูุชุทูุจ ููุงููุฉ ุงููุฏูุฑ.

---

## โ ุงูุชุญุฏูุซุงุช ุงููููุฐุฉ

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช
ุชู ุฅุถุงูุฉ ุญูููู ุฌุฏูุฏูู ุฅูู ุฌุฏูู `doctors`:

#### ุงูุญููู ุงูุฌุฏูุฏุฉ:
- **`delete_requested`** (BOOLEAN): ูุดูุฑ ุฅูู ุฃู ุงูุทุจูุจ ุทูุจ ุญุฐู ุญุณุงุจู
  - ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ: `FALSE`
  
- **`delete_requested_at`** (TIMESTAMP): ุชุงุฑูุฎ ูููุช ุทูุจ ุญุฐู ุงูุญุณุงุจ
  - ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ: `NULL`

#### ููู SQL:
๐ **`add_delete_request_column.sql`**

**ููููุฉ ุงูุชูููุฐ:**
1. ุงูุชุญ Supabase Dashboard
2. ุงุฐูุจ ุฅูู SQL Editor
3. ุงูุณุฎ ูุญุชูู ุงูููู `add_delete_request_column.sql`
4. ููุฐ ุงูุณูุฑูุจุช

---

### 2. ูููุฐุฌ ุงูุจูุงูุงุช (Doctor Model)
ุชู ุชุญุฏูุซ **`lib/models/doctor_model.dart`**:

#### ุงูุญููู ุงููุถุงูุฉ:
```dart
final bool deleteRequested;           // ุทูุจ ุงูุญุฐู
final DateTime? deleteRequestedAt;    // ุชุงุฑูุฎ ุงูุทูุจ
```

#### ุงูุชุญุฏูุซุงุช:
- โ ุฅุถุงูุฉ ุงูุญููู ุฅูู Constructor
- โ ูุฑุงุกุฉ ุงูุญููู ูู JSON
- โ ูุชุงุจุฉ ุงูุญููู ุฅูู JSON

---

### 3. ุฎุฏูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช (DoctorDatabaseService)
ุชู ุชุญุฏูุซ **`lib/services/doctor_database_service.dart`**:

#### ุงูุฏูุงู ุงูุฌุฏูุฏุฉ:

##### 1. **`requestDeleteAccount()`**
ุฅุฑุณุงู ุทูุจ ุญุฐู ุงูุญุณุงุจ ููุทุจูุจ ุงูุญุงูู
```dart
await _dbService.requestDeleteAccount();
```
- ูุญุฏุซ ุญูู `delete_requested` ุฅูู `true`
- ูุณุฌู ุชุงุฑูุฎ ุงูุทูุจ ูู `delete_requested_at`

##### 2. **`cancelDeleteRequest()`**
ุฅูุบุงุก ุทูุจ ุญุฐู ุงูุญุณุงุจ
```dart
await _dbService.cancelDeleteRequest();
```
- ูุญุฏุซ ุญูู `delete_requested` ุฅูู `false`
- ููุณุญ ุชุงุฑูุฎ ุงูุทูุจ (`delete_requested_at` = `null`)

##### 3. **`deleteDoctorAccount(doctorId)`** (ูุญุฏุซุฉ)
ุญุฐู ุงูุญุณุงุจ ุงููุนูู (ูููุฏูุฑ ููุท)
```dart
await _dbService.deleteDoctorAccount(doctorId);
```

---

### 4. ุงููุงุฌูุฉ (Doctor Profile Screen)
ุชู ุชุญุฏูุซ **`lib/screens/doctor_profile_screen.dart`**:

#### ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ:

##### ุฃ) ุนุฑุถ ุญุงูุฉ ุทูุจ ุงูุญุฐู
ุนูุฏูุง ูููู `deleteRequested = true`:
- ๐ฆ **ุจุทุงูุฉ ุชุญุฐูุฑูุฉ ุจุฑุชูุงููุฉ** ุชุนุฑุถ:
  - โ ุฑุณุงูุฉ "ุชู ุฅุฑุณุงู ุทูุจ ุญุฐู ุงูุญุณุงุจ"
  - โฐ ุชุงุฑูุฎ ุฅุฑุณุงู ุงูุทูุจ
  - ๐ ุฒุฑ "ุฅูุบุงุก ุทูุจ ุงูุญุฐู"

##### ุจ) ุฒุฑ ุทูุจ ุงูุญุฐู
ุนูุฏูุง ูููู `deleteRequested = false`:
- ๐ด **ุฒุฑ "ุทูุจ ุญุฐู ุงูุญุณุงุจ"**
  - ุชุตููู OutlinedButton ุจุงูููู ุงูุฃุญูุฑ
  - ุฃููููุฉ delete_forever

##### ุฌ) ุงูุฏูุงู ุงูุฌุฏูุฏุฉ:

###### 1. **`_handleDeleteAccount()`**
- ูุนุฑุถ ูุฑุจุน ุญูุงุฑ ุชุฃููุฏ
- ูุฑุณู ุทูุจ ุงูุญุฐู (ูุง ูุญุฐู ูุจุงุดุฑุฉ)
- ูุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ
- ูุญุฏุซ ุงูุจูุงูุงุช ูุนุฑุถ ุญุงูุฉ ุงูุทูุจ

###### 2. **`_handleCancelDeleteRequest()`**
- ูุนุฑุถ ูุฑุจุน ุญูุงุฑ ุชุฃููุฏ
- ููุบู ุทูุจ ุงูุญุฐู
- ูุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ
- ูุญุฏุซ ุงูุจูุงูุงุช

###### 3. **`_formatDate(DateTime)`**
- ุชูุณูู ุงูุชุงุฑูุฎ ุจุงูุนุฑุจูุฉ
- ุนุฑุถ: "1 ููุงูุฑ 2026"

---

## ๐จ ุงูุชุตููู

### ุจุทุงูุฉ ุทูุจ ุงูุญุฐู ุงููุนูู:
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โ๏ธ  ุชู ุฅุฑุณุงู ุทูุจ ุญุฐู ุงูุญุณุงุจ         โ
โ                                       โ
โ ูู ุงูุชุธุงุฑ ููุงููุฉ ุงููุฏูุฑ ุนูู         โ
โ ุทูุจ ุญุฐู ุญุณุงุจู                        โ
โ                                       โ
โ ุชุงุฑูุฎ ุงูุทูุจ: 1 ููุงูุฑ 2026           โ
โ                                       โ
โ [ ุฅูุบุงุก ุทูุจ ุงูุญุฐู ]                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ุฒุฑ ุทูุจ ุงูุญุฐู:
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐๏ธ  ุทูุจ ุญุฐู ุงูุญุณุงุจ                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ุณูุฑ ุงูุนูู (Workflow)

### ููุทุจูุจ:
1. **ุฅุฑุณุงู ุทูุจ ุงูุญุฐู:**
   - ุงูุถุบุท ุนูู ุฒุฑ "ุทูุจ ุญุฐู ุงูุญุณุงุจ"
   - ุชุฃููุฏ ุงูุทูุจ
   - โ ูุชู ุฅุฑุณุงู ุงูุทูุจ ูููุฏูุฑ

2. **ุฅูุบุงุก ุงูุทูุจ (ุงุฎุชูุงุฑู):**
   - ุงูุถุบุท ุนูู "ุฅูุบุงุก ุทูุจ ุงูุญุฐู"
   - ุชุฃููุฏ ุงูุฅูุบุงุก
   - โ ูุชู ุฅูุบุงุก ุงูุทูุจ

3. **ุจุนุฏ ููุงููุฉ ุงููุฏูุฑ:**
   - ๐๏ธ ูุชู ุญุฐู ุงูุญุณุงุจ ููุงุฆูุงู
   - ูุง ูููู ุงููุตูู ููุญุณุงุจ ูุฑุฉ ุฃุฎุฑู

### ูููุฏูุฑ:
1. **ุนุฑุถ ุทูุจุงุช ุงูุญุฐู:**
   - ูู ููุญุฉ ุงูุชุญููุ ูููู ูููุฏูุฑ ุฑุคูุฉ ุงูุฃุทุจุงุก ุงูุฐูู ูุฏููู `delete_requested = true`

2. **ุงูููุงููุฉ ุนูู ุงูุทูุจ:**
   - ุงููุฏูุฑ ูุณุชุฏุนู `deleteDoctorAccount(doctorId)`
   - ูุชู ุญุฐู ุงูุญุณุงุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - ูุชู ุญุฐู ุจูุงูุงุช Auth

3. **ุฑูุถ ุงูุทูุจ (ุงุฎุชูุงุฑู):**
   - ุงููุฏูุฑ ููููู ุชุญุฏูุซ `delete_requested = false`
   - ูุจูู ุงูุญุณุงุจ ูุดุทุงู

---

## ๐ ุงูุฃูุงู ูุงูุตูุงุญูุงุช

### ุตูุงุญูุงุช ุงูุทุจูุจ:
- โ ุฅุฑุณุงู ุทูุจ ุญุฐู ุญุณุงุจู ุงูุฎุงุต
- โ ุฅูุบุงุก ุทูุจ ุงูุญุฐู ุงูุฎุงุต ุจู
- โ **ูุง ููููู** ุญุฐู ุงูุญุณุงุจ ูุจุงุดุฑุฉ

### ุตูุงุญูุงุช ุงููุฏูุฑ:
- โ ุนุฑุถ ุฌููุน ุทูุจุงุช ุงูุญุฐู
- โ ุญุฐู ุฃู ุญุณุงุจ ุทุจูุจ
- โ ุฑูุถ ุทูุจ ุงูุญุฐู

---

## ๐ ููุงุนุฏ RLS (Row Level Security)

ุงูุณูุงุณุงุช ุงูููุฌูุฏุฉ ุชุณูุญ ููุทุจูุจ ุจู:
- โ **UPDATE**: ุชุญุฏูุซ `delete_requested` ู `delete_requested_at`
  ```sql
  CREATE POLICY "Doctors can update their own profile"
    ON public.doctors FOR UPDATE
    USING (auth.uid() = id)
    WITH CHECK (auth.uid() = id);
  ```

ุงููุฏูุฑ ููููู:
- โ **DELETE**: ุญุฐู ุฃู ุญุณุงุจ ุทุจูุจ
  ```sql
  CREATE POLICY "Admins can delete any doctor"
    ON public.doctors FOR DELETE
    USING (auth.uid() IN (SELECT id FROM public.admins));
  ```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุทูุจ ุงูุญุฐู:
1. ุณุฌู ุฏุฎูู ูุทุจูุจ
2. ุงูุชุญ ุงูููู ุงูุดุฎุตู
3. ุงุถุบุท ุนูู "ุทูุจ ุญุฐู ุงูุญุณุงุจ"
4. ุชุญูู ูู:
   - โ ุธููุฑ ุฑุณุงูุฉ ุงููุฌุงุญ
   - โ ุธููุฑ ุจุทุงูุฉ "ุชู ุฅุฑุณุงู ุทูุจ ุญุฐู ุงูุญุณุงุจ"
   - โ ุชุณุฌูู ุงูุชุงุฑูุฎ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงุฎุชุจุงุฑ ุฅูุบุงุก ุงูุทูุจ:
1. ุจุนุฏ ุฅุฑุณุงู ุงูุทูุจ
2. ุงุถุบุท ุนูู "ุฅูุบุงุก ุทูุจ ุงูุญุฐู"
3. ุชุญูู ูู:
   - โ ุฅุฎูุงุก ุจุทุงูุฉ ุงูุทูุจ
   - โ ุธููุฑ ุฒุฑ "ุทูุจ ุญุฐู ุงูุญุณุงุจ" ูุฑุฉ ุฃุฎุฑู
   - โ ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช

---

## ๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช - ุงุณุชุนูุงูุงุช ูููุฏุฉ

### ุนุฑุถ ุฌููุน ุทูุจุงุช ุงูุญุฐู ุงููุนููุฉ:
```sql
SELECT 
  id, 
  full_name, 
  email, 
  delete_requested_at,
  specialization
FROM public.doctors
WHERE delete_requested = TRUE
ORDER BY delete_requested_at DESC;
```

### ุฅุญุตุงุฆูุงุช ุทูุจุงุช ุงูุญุฐู:
```sql
SELECT 
  COUNT(*) as total_delete_requests,
  COUNT(CASE WHEN delete_requested_at > NOW() - INTERVAL '7 days' THEN 1 END) as recent_requests
FROM public.doctors
WHERE delete_requested = TRUE;
```

---

## ๐ฏ ุงูููุงุฆุฏ

### 1. **ุญูุงูุฉ ุฃูุถู ููุจูุงูุงุช**
- ุชุฌูุจ ุงูุญุฐู ุงูุนุฑุถู
- ูุฑุตุฉ ูููุฑุงุฌุนุฉ ูุจู ุงูุญุฐู ุงูููุงุฆู

### 2. **ุณุฌู ุชุงุฑูุฎู**
- ุชุชุจุน ูุชู ุทูุจ ุงูุทุจูุจ ุญุฐู ุญุณุงุจู
- ุฅููุงููุฉ ุงููุฑุงุฌุนุฉ ูุงูุชุญููู

### 3. **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู**
- ุงูุทุจูุจ ููููู ุชุบููุฑ ุฑุฃูู
- ูุถูุญ ูู ุงูุญุงูุฉ (ูุนูู/ููุบู)

### 4. **ุชุญูู ุฅุฏุงุฑู**
- ุงููุฏูุฑ ููููู ูุฑุงุฌุนุฉ ุงูุทูุจุงุช
- ุงูุชุญูู ูู ุฃุณุจุงุจ ุงูุญุฐู ูุจู ุงูููุงููุฉ

---

## ๐ง ุงูุชุทููุฑ ุงููุณุชูุจูู

### ุงูุชุฑุงุญุงุช ููุชุญุณูู:
1. **ุฅุถุงูุฉ ุณุจุจ ุงูุญุฐู:**
   - ุญูู `delete_reason` (ูุต)
   - ุงูุทุจูุจ ููุชุจ ุณุจุจ ุทูุจ ุงูุญุฐู

2. **ุฅุดุนุงุฑุงุช:**
   - ุฅุดุนุงุฑ ูููุฏูุฑ ุนูุฏ ุทูุจ ุฌุฏูุฏ
   - ุฅุดุนุงุฑ ููุทุจูุจ ุนูุฏ ุงูููุงููุฉ/ุงูุฑูุถ

3. **ูุชุฑุฉ ุณูุงุญ:**
   - ุญุฐู ุชููุงุฆู ุจุนุฏ 30 ููู ูู ุงูุทูุจ
   - ุชุญุฐูุฑ ูุจู ุงูุญุฐู ุงูููุงุฆู

4. **ุฃุฑุดูุฉ ุงูุจูุงูุงุช:**
   - ููู ุงูุจูุงูุงุช ุฅูู ุฌุฏูู ุฃุฑุดูู ูุจู ุงูุญุฐู
   - ุงูุงุญุชูุงุธ ุจุณุฌู ุชุงุฑูุฎู

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุชุญูู ูู ุชูููุฐ ููู SQL
2. ุชุฃูุฏ ูู ุตูุงุญูุงุช RLS
3. ุฑุงุฌุน console ููุฃุฎุทุงุก

---

## โจ ุงูููุฎุต

ุชู ุชุญููู ูุธุงู ุญุฐู ุงูุญุณุงุจ ูู:
- โ **ุญุฐู ููุฑู ูุฎุทูุฑ**

ุฅูู:
- โ **ูุธุงู ุทูุจุงุช ุขูู ููุฑู**
- โ **ููุงููุฉ ุงููุฏูุฑ ูุทููุจุฉ**
- โ **ุฅููุงููุฉ ุงูุฅูุบุงุก ูุจู ุงูููุงููุฉ**
- โ **ุชุชุจุน ุชุงุฑูุฎู ููุทูุจุงุช**

๐ **ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู!**
